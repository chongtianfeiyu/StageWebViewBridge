<?xml version="1.0" ?>
<project basedir="./.." name="iMomentos">
    <!-- SDK properties -->
    <property name="SDK_HOME" value="/Applications/Adobe Flash Builder 4.5/sdks/flex_sdk_4.5.1.21328_mpl_air_sdk_2.7"/>
    <property name="ADT.JAR" value="${SDK_HOME}/lib/adt.jar"/>
 
    <!-- Project properties -->
    <property name="APP_NAME" value="iMomentos"/>
    <property name="APP_ROOT_DIR" value="."/>
    <property name="BIN_DIR" location="bin"/>
    <property name="BIN_IOS_DIR" location="${BIN_DIR}/bin-ios"/>
    <property name="BUILD_DIR" location="build"/>
    <property name="APP_ROOT_FILE" value="${BIN_DIR}/${APP_NAME}.swf"/>
    <property name="APP_BIN_FILE" value="${BIN_IOS_DIR}/${APP_NAME}.swf"/>
    <property name="APP_DESCRIPTOR" value="${BIN_IOS_DIR}/${APP_NAME}-ios.xml"/>
    
	<property name="CERT_DIR" value="cert"/>    
    <property name="STORETYPE" value="pkcs12"/>
    <property name="KEYSTORE" value="${CERT_DIR}/certificate.p12"/>
    <property name="PROVISIONING_PROFILE" value="${CERT_DIR}/provisioning.mp"/>
	<property name="STOREPASS" value="1234"/>
 	<property name="SOURCE_DESCRIPTOR" value="${BUILD_DIR}/build.app.xml"/>
 	<property name="WWW_DIR" value="html"/>
 	<property name="WWW_CACHEDIR" value="htmlCache"/>
 	<property name="WWW_SOURCEDIR" value="htmlSource"/>
 	<property name="ICONS_DIR" value="${BIN_IOS_DIR}/icons"/>
 	<property name="DEFAULT_IMAGE" value="${BIN_IOS_DIR}/Default.png"/>  
 
 	<property name="IPA_ADHOC" value="ipa-ad-hoc"/>
 	<property name="IPA_STORE" value="ipa-app-store"/>
 	<property name="IPA_DEBUG" value="ipa-debug"/>
 	<property name="IPA_TEST" value="ipa-test"/>
 	<property name="IPA-INTERPRETED" value="ipa-test-interpreter"/>
 
 
    <target name="[ - ] IPA-INTERPRETED" depends="update.BuildNumber,updateDescriptor">
    	<property name="TARGET" value="${IPA-INTERPRETED}"/>
    	<property name="IPA_NAME" value="${BIN_IOS_DIR}/debug/${APP_NAME}.ipa"/>
 		<antcall target="compile"/>
    </target>
	
    <target name="[ - ] IPA_TEST" depends="update.BuildNumber,updateDescriptor">
    	<property name="TARGET" value="${IPA_TEST}"/>
    	<property name="IPA_NAME" value="${BIN_IOS_DIR}/debug/${APP_NAME}.ipa"/>
 		<antcall target="compile"/>
    </target>
	
    <target name="[ - ] IPA_STORE" depends="update.BuildNumber,updateDescriptor">
    	<property name="TARGET" value="${IPA_STORE}"/>
    	<property name="IPA_NAME" value="${BIN_IOS_DIR}/debug/${APP_NAME}.ipa"/>
 		<antcall target="compile"/>
    </target>	

	<target name="compile">
		<copy file="${APP_ROOT_FILE}" tofile="${APP_BIN_FILE}" overwrite="true"/>
        <java jar="${ADT.JAR}" fork="true" failonerror="true">

            <arg value="-package"/>
            <arg value="-target"/>
            <arg value="${TARGET}"/>
            <arg value="-keystore"/>
            <arg value="${KEYSTORE}"/>
            <arg value="-storetype"/>
            <arg value="${STORETYPE}"/>
            <arg value="-storepass"/>
            <arg value="${STOREPASS}"/>
            <arg value="-provisioning-profile"/>
            <arg value="${PROVISIONING_PROFILE}"/>
            <arg value="${IPA_NAME}"/>
            <arg value="${APP_DESCRIPTOR}"/>
            <arg value="-C"/>
            <arg value="${BIN_IOS_DIR}"/>
            <arg value="${APP_BIN_FILE}"/>
            <arg value="${ICONS_DIR}"/>
            <arg value="${DEFAULT_IMAGE}"/>
            <arg value="-C"/>
            <arg value="${BIN_DIR}"/>            
            <arg value="${WWW_DIR}"/>
        </java>
		<antcall target="iTunesUpdate"/>
	</target>
	
	<target name="iTunesUpdate">
		<exec executable="sh" dir="${BIN_IOS_DIR}/debug/">
			<arg value="update.sh"/>
		</exec>
	</target>
	
	<target name="compileFDT">
		
		<fdt.launch.application projectname="iMomentos" debug="false" startswf="true" swflauncher="AIR Debug Launcher" mainclass="src/com/casadaqiao/momentos/core/iMomentos.as" target="bin/iMomentos.swf" />
	</target>
 
    
    <target name="clearHTMLCache">
		<delete verbose="true" includeemptydirs="true">
			<fileset dir="${WWW_CACHEDIR}" includes="**/*.html,**/*.htm,**/*.js,**/*.css" />
		</delete>    
    </target>
    
    <target name="updateDescriptor">
		<copy file="${SOURCE_DESCRIPTOR}" tofile="${APP_DESCRIPTOR}" overwrite="true"/>
		<replace file="${APP_DESCRIPTOR}" propertyFile="build/build.number">
			<replacefilter token="@majorVersion@" property="build.majorVersion" />
			<replacefilter token="@minorVersion@" property="build.minorVersion" />			
			<replacefilter token="@buildNumber@" property="build.number" />
			<replacefilter token="@id@" value="${APP_NAME}" />
			<replacefilter token="@name@" value="${APP_NAME}" />
			<replacefilter token="@filename@" value="${APP_NAME}" />
		</replace>   
    </target>
	<target name="update.BuildNumber">
		<propertyfile file="build/build.number">
			<entry key="build.number" type="int" default="0" operation="+" pattern="0" />
		</propertyfile>	
	</target>
	<target name="update.MinorVersion">
		<propertyfile file="build/build.number">
			<entry key="build.minorVersion" type="int" default="0" operation="+" pattern="0" />
			<entry key="build.number" type="int" value="0" operation="=" pattern="0" />
		</propertyfile>	
	</target>
	<target name="update.MajorVersion">
		<propertyfile file="build/build.number">
			<entry key="build.majorVersion" type="int" default="0" operation="+" pattern="0" />		
			<entry key="build.minorVersion" type="int" value="0" operation="=" pattern="0" />
			<entry key="build.number" type="int" value="0" operation="=" pattern="0" />
		</propertyfile>	
	</target>
	<target name="resetBuild">
		<propertyfile file="build/build.number">
			<entry key="build.majorVersion" type="int" default="0" value="0" operation="=" pattern="0" />		
			<entry key="build.minorVersion" type="int" default="0" value="0" operation="=" pattern="0" />
			<entry key="build.number" 		type="int" default="0" value="0" operation="=" pattern="0" /> 
		</propertyfile>	
	</target>			   
</project>